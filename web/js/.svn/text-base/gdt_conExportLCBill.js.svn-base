//间接融资-贸易融资》出口L/C押汇		
$(function(obj){
	var m = document.getElementById('m').value;
	/*var bussClass = $("select[id$=.bussClass]").val('CLMS03');*/
	var bussClass = $("select[id$='.bussClass']").attr('value','CLMS03');
	var bussVariety = $("select[id$='.bussVariety']");
	if(m =='a'){
		doChange(bussClass[0]);
		//隐藏业务品种和分类,展示值
		/*$("select[id$=.bussVariety]").val('CLMS21');*/
		$("select[id$='.bussVariety']").attr('value','CLMS21');
	}
	
	var cltName = $("input[id$='.cltName']").val();
	var apply = $("input[id$='_form.applyId']").val();

	if(apply != undefined && apply != null && apply != ''){
		var clt = $("input[id$='_info.cltName']");
		doHiddenApply(clt);
		doHidden(bussClass,bussVariety);
		//隐藏票据选择
		$('[id$="bill.sel"]').hide();
		$('[id$="bill.del"]').hide();
		var list=$('table[id="'+$('input[id$="pageCode"]').val()+'_bill"]');
		var trs=list.find('tbody tr:visible');
		for(var i=0;i<trs.length;i++){
			$(trs[i]).find('input[id$="_check"]').hide().attr({"disabled":true});
		}
	}
	
	var channel = $("input[id$='gdt_conExportLCBill_form.channel']").val();
    //当channel字段不为GDEBIT时，将带入的数据置换为不可写
	if(isNotNull(channel) && channel != "GDEBIT"){
		var table = $("#gdt_conExportLCBill_info");
		doReadOnly(table);
	}
});
//提交/保存  之前先进行校验
function saveCheck(){
	$("input").removeAttr("disabled");
	var bussVariety = $("select[id$=.bussVariety]").val();
	if(!doCheckBankIsNull(bussVariety)){
		alert("合作金融网点不存在！");
		return false;
	}
	var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
	if(bill.length == 0){
		alert("请选择押汇单据信息!");
		return false;
	}
	var tr = $(bill.get(0));
	var currencyNo = $('select[id$=_info.currencyNo]').val();
	if(currencyNo == undefined ){
		currencyNo = $('input[id$=_info.currencyNo]').val();
	}
	var billCurrencyNo = tr.find('input[id$=_bill.currencyNo]').val();
	if(currencyNo != billCurrencyNo){
		alert("合同币种与单据币种不一致");
		return
	}
	var applyDate = $("input[id$=_info.applyDate]").val();
	var applyMsg = "申请日期";
	if(applyDate == undefined){
		applyDate = $("input[id$=_info.contractDate]").val();
		applyMsg = "签约日期"
	}
	//到单日期
	var dueDate = tr.find('input[id$=_bill.endDate]').val();
	if(!compareDate(dueDate,applyDate, applyMsg+'不能早于单据的交单日期')){
		return false;
	}
	//开始日
	var startDate = $('input[id$=.startDate]').val();
	if(!compareDate(applyDate,startDate,applyMsg+'不能晚于开始日期')){
		return false;
	}
	//到期日
	var endDate = $('input[id$=.endDate]').val();
	//信用证有效期
	var lcDueDate = tr.find('input[id$=_bill.lcDueDate]').val();
	if(!compareDate(endDate, lcDueDate, '到期日不能晚于信用证的有效期')){
		return false;
	}
	var files = $('input[id$=applyFiles_filetext]');
	if(!validateFileForamtBatch(files)){
		alert("系统不允许上传可执行格式的文件");
		return false;
	}
	return true;
}
//计算期限
function setTermDay(){
	var pageCode = $("input[id=pageCode]").val();
	var startDate = $('input[id$=.startDate]').val();
	var endDate = $('input[id$=.endDate]').val();
	if(!compareDate(startDate, endDate, '开始日不能晚于到期日')){
		$('input[id$=_info.endDate]').val('');
		return false;
	}
	if(startDate != '' && endDate != ''){
		var termDay = DateCompare(startDate,endDate);
		var html  = "<input id='" + pageCode + "_info.termDay' name='" + pageCode + "_info.termDay' type='hidden' value='"+termDay+"'/>"
		$('input[id$=.termDay]').parent().html(termDay + "天" + html);
	}
	setExpectIntr();
}

//计算押汇利息
function setExpectIntr(){
	
	var rate = $('input[id$=_info.rate]');
	if(rate.val() !=''){
		if(100.0-parseFloat(rate.val().excludeNotNumericDot())<0){
			alert("利率值不能超过100");
			rate.val('');
			return;
		}
	}
	var amount = $('input[id$=_info.amount]').val().excludeNotNumericDot();
	var rateVal = rate.val()/100;
	var interestAccDay = $('select[id$=_info.interestAccDay]').val();
	var termDay = $('[id$=_info.termDay]').val();
	if(amount =='' || rateVal == '' || interestAccDay == '' || termDay == 0){
		return;
	}
	var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
	var tr = $(bill.get(0));
	var forexType = tr.find('input[id$=_bill.forexType]').val();
	if(forexType == 'FORWARD'){
		var startDate = $('input[id$=.startDate]').val();
		var payDate = tr.find('input[id$=.payDate]').val();
		termDay = dateDiff(startDate,payDate);
	}	
	var expectIntr = accDiv(accMul(accMul(amount,rateVal),termDay),interestAccDay);
	var expectIntrVal = FormatMoney(expectIntr,2);
	/*if(expectIntrVal == ''){
		expectIntrVal = '0.00';
	}*/
	$('input[id$=_info.expectIntr]').val(FormatMoney(expectIntrVal,2));
}
//选择单据
function doSelectSDBill(){
	var bill = $("table[id^=gdt][id$=_bill]").find("tbody tr:visible");
	/*if(bill.length > 0){
		alert("只能选择一条押汇单据信息!");
		return;
	}*/
	var cltNo = $("input[id$=_info.cltNo]").val();
	if(cltNo == ''){
		alert("请先选择单位")
		return;
	}
	var cltName = $("input[id$=_info.cltName]").val();
	//大行
	var bankName = $("input[id$=_info.bankName]").val();
	//币种
	var currencyNo = $("select[id$='_info.currencyNo']").val();
	//申请日
	var applyDate = $("input[id$=_info.applyDate]").val();
	if(applyDate == undefined){
		applyDate = $("input[id$=_info.contractDate]").val();
	}
	//开始日
	payDate = $("input[id$=_info.endDate]").val();
	var url="GDEBIT@gdt_select_SDJ.sf?m=v&cltNo="+cltNo+"&cltName="+cltName+"&bankName="+bankName
	+"&currencyNo="+currencyNo+"&applyDate="+applyDate+"&payDate="+payDate;
	openwin(url, '选择单据', 1100,600);
}
//回显单据
function setSDBill(data){
	var checks= $('input[id$="_bill.billId"]');
	if(checks != undefined && checks.length != 0){
		$(checks).each(function(){
			if(this.value==undefined || this.value == null || this.value == '')return;
			nstc.sf.delCurrRow(this)
		});
	}
	
	var billNo = data.billNo;
	var billId = data.billId;
	var lcNo = data.lcNo;
	var lcWbId = data.lcWbId;
	var payBankName = data.payBankName;
	var payBankNo = data.payBankNo;
	var endDate = data.endDate;
	var currencyName = data.currencyName;
	var currencyNo = data.currencyNo;
	var billAmount = data.billAmount;
	var payDate = data.payDate;
	var supplierName = data.supplierName;
	var description = data.description;
	
	var forexType = data.forexType;
	var forexTypeName = data.forexTypeName;
	var lcAmount = data.lcAmount;
	var accBankName = data.accBankName;
	var lcDueDate = data.lcDueDate;
	
	var btnAdd = $("input[id$='_bill.add']")[0];
	var tr_row = smartForm_add(btnAdd);
	var tr = $(tr_row);
	
	tr.find("input[id$='.billId']").val(billId);
	tr.find("input[id$='.lcWbId']").val(lcWbId);
	tr.find("input[id$='.billAmount']").val(billAmount);
	tr.find("input[id$='.currencyNo']").val(currencyNo);
	
	var pageCode = $("input[id$='pageCode']").val();
	var billNoHtml  = "<input id='"+pageCode+"_bill.billNo' name='"+
	pageCode+"_bill.billNo' type='hidden' value='"+billNo+"'/>";
	var billidHtml  = "<input id='"+pageCode+"_bill.billId' name='"+
	pageCode+"_bill.billId' type='hidden' value='"+billId+"'/>";
    var billNoLink = "<a href='#' onclick='showSDBillMsg(this)'>" + billNo + "</a>";
	tr.find("input[id$=_bill.billNo]").parent().parent().html(billNoLink +billidHtml+ billNoHtml);
	
	var lcNoHtml  = "<input id='"+pageCode+"_bill.lcNo' name='"+
	pageCode+"_bill.lcNo' type='hidden' value='"+lcNo+"'/>";
	var lcNoLink = "<a href='#' onclick='showLCbill(this)'>" + lcNo + "</a>";
	tr.find("input[id$=_bill.lcNo]").parent().html(lcNoLink + lcNoHtml);
	
	var payBankNoHtml  = "<input id='"+pageCode+"_bill.payBankNo' name='"+
	pageCode+"_bill.payBankNo' type='hidden' value='"+payBankNo+"'/>";
	tr.find("input[id$=_bill.payBankNo]").parent().html(payBankName + payBankNoHtml);
	
	var endDateHtml  = "<input id='"+pageCode+"_bill.endDate' name='"+
	pageCode+"_bill.endDate' type='hidden' value='"+endDate+"'/>";
	tr.find("input[id$=_bill.endDate]").parent().html(endDate + endDateHtml);
	
	/*var currencyNameHtml  = "<input id='"+pageCode+"_bill.currencyName' name='"+
	pageCode+"_bill.currencyName' type='hidden' value='"+currencyName+"'/>";
	tr.find("input[id$=_bill.currencyName]").parent().html(currencyName + currencyNameHtml);*/
	
	var currencyNoHtml  = "<input id='"+pageCode+"_bill.currencyNo' name='"+
	pageCode+"_bill.currencyNo' type='hidden' value='"+currencyNo+"'/>";
	tr.find("input[id$=_bill.currencyNo]").parent().html(currencyName + currencyNoHtml);
	
	var billAmountHtml  = "<input id='"+pageCode+"_bill.billAmount' name='"+
	pageCode+"_bill.billAmount' type='hidden' value='"+billAmount+"'/>";
	tr.find("input[id$=_bill.billAmount]").parent().html("<span style ='text-align: right; font-weight: bold;'>"+FormatMoney(billAmount,2)+"</span>"
			+billAmountHtml);
	
	var payDateHtml  = "<input id='"+pageCode+"_bill.payDate' name='"+
	pageCode+"_bill.payDate' type='hidden' value='"+payDate+"'/>";
	tr.find("input[id$=_bill.payDate]").parent().html(payDate + payDateHtml);

	var supplierNameHtml  = "<input id='"+pageCode+"_bill.supplierName' name='"+
	pageCode+"_bill.supplierName' type='hidden' value='"+supplierName+"'/>";
	tr.find("input[id$=_bill.supplierName]").parent().html(supplierName + supplierNameHtml);
	//修改合同金额
	var amountHtml  = "<input id='"+pageCode+"_info.amount' name='"+
	pageCode+"_info.amount' type='hidden' value='"+billAmount+"'/>";
	$("input[id$=_info.amount]").parent().html(FormatMoney(billAmount,2) + amountHtml);
	//计算押汇利息
	setExpectIntr();
	var forexTypeHtml  = "<input id='"+pageCode+"_bill.forexType' name='"+
	pageCode+"_bill.forexType' type='hidden' value='"+forexType+"'/>";
	tr.find("input[id$=_bill.forexType]").parent().html(forexTypeName + forexTypeHtml);
		
	var lcDueDateHtml  = "<input id='"+pageCode+"_bill.lcDueDate' name='"+
	pageCode+"_bill.lcDueDate' type='hidden' value='"+lcDueDate+"'/>";
	tr.find("input[id$=_bill.lcDueDate]").parent().html(lcDueDate + lcDueDateHtml)
}
